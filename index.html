<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Poupan√ßa MealPrep</title>

<link rel="manifest" href="manifest.json">

<script src="https://unpkg.com/quagga/dist/quagga.min.js"></script>
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<style>
body{background:#0f1115;color:#e6e6e6;font-family:-apple-system,Arial;margin:0;padding:14px}
h2{margin-top:4px}
.row{display:flex;gap:8px;flex-wrap:wrap}
.card{background:#1a1f27;border:1px solid #2a313c;padding:12px;margin:10px 0;border-radius:12px}
button{padding:9px 10px;border-radius:8px;border:none;background:#2e7d32;color:white;font-weight:600}
button.alt{background:#39424e}
button.warn{background:#b00020}
input,select{padding:8px;margin:5px 0;background:#11161c;color:#fff;border:1px solid #2a313c;border-radius:8px;width:100%}
.small{font-size:12px;color:#9aa4b2}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:#000a;display:flex;align-items:center;justify-content:center}
.modal-content{background:#141922;padding:16px;border-radius:14px;width:92%;max-width:520px}
.badge{background:#263241;padding:3px 6px;border-radius:6px;margin-left:6px;font-size:11px}
</style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">

const STORES=["Albert Heijn","Lidl","Action","Jumbo","Outro"]

// Premissas financeiras (edit√°veis)
const HOURS_PER_WEEK = 35
const HOURLY_WAGE = 14
const MEALS_PER_WEEK = 14

function App(){

const [items,setItems]=React.useState(JSON.parse(localStorage.getItem("items")||"[]"))
const [showForm,setShowForm]=React.useState(false)
const [showScanner,setShowScanner]=React.useState(false)
const [newItem,setNewItem]=React.useState({name:"",price:"",qty:"",barcode:"",store:"Albert Heijn"})
const [suggestions,setSuggestions]=React.useState([])

React.useEffect(()=>{
 localStorage.setItem("items",JSON.stringify(items))
 computeSuggestions()
},[items])

function addItem(){
 if(!newItem.name) return
 const history = newItem.price ? [{price:newItem.price,store:newItem.store,date:new Date().toISOString()}] : []
 setItems([...items,{...newItem,id:Date.now(),history}])
 setNewItem({name:"",price:"",qty:"",barcode:"",store:"Albert Heijn"})
 setShowForm(false)
}

function consume(id){
 const q=prompt("Quanto consumiste?")
 if(!q) return
 setItems(items.map(i=> i.id===id ? {...i,qty:Math.max(0,(parseFloat(i.qty||0)-parseFloat(q)).toString())}:i))
}

function addPriceRecord(id){
 const price=prompt("Novo pre√ßo ‚Ç¨")
 const store=prompt("Loja?")
 if(!price||!store) return
 setItems(items.map(i=> i.id===id ? {...i,price,store,history:[...(i.history||[]),{price,store,date:new Date().toISOString()}]}:i))
}

function startScanner(){
 setShowScanner(true)
 setTimeout(()=>{
 Quagga.init({
  inputStream:{type:"LiveStream",target:document.querySelector('#scanner'),constraints:{facingMode:"environment"}},
  decoder:{readers:["ean_reader","code_128_reader"]}
 },err=>{
  if(!err){
   Quagga.start()
   Quagga.onDetected(data=>{
    setNewItem(v=>({...v,barcode:data.codeResult.code}))
    stopScanner()
    setShowForm(true)
   })
  }
 })
 },300)
}

function stopScanner(){
 try{Quagga.stop()}catch(e){}
 setShowScanner(false)
}

// Financeiro
function weeklyIncome(){
 return HOURS_PER_WEEK * HOURLY_WAGE
}

function weeklyFoodSpend(){
 return items.reduce((sum,i)=>sum+(parseFloat(i.price)||0),0)
}

function avgMealCost(){
 return (weeklyFoodSpend()/MEALS_PER_WEEK || 0).toFixed(2)
}

function workMinutesPerMeal(){
 const cost = parseFloat(avgMealCost())
 return Math.round((cost/HOURLY_WAGE)*60) || 0
}

function expensiveAlerts(){
 return items.filter(i=>{
  if(!i.history || i.history.length<2) return false
  const avg = i.history.reduce((s,h)=>s+parseFloat(h.price),0)/i.history.length
  return parseFloat(i.price) > avg*1.15
 })
}

// Sugest√µes + custo por refei√ß√£o (heur√≠stico simples)
function computeMealCost(recipeItems){
 let total=0
 recipeItems.forEach(name=>{
  const it=items.find(i=>i.name.toLowerCase().includes(name))
  if(it && it.price && it.qty){
   total+= (parseFloat(it.price)/Math.max(parseFloat(it.qty)||1,1))
  }
 })
 return total.toFixed(2)
}

function computeSuggestions(){
 const names=items.map(i=>i.name.toLowerCase())
 const s=[]
 if(names.some(n=>n.includes("feij√£o")) && names.some(n=>n.includes("cebola"))){
  s.push({title:"Feij√£o com cebola e √≥leo", cost:computeMealCost(["feij√£o","cebola"])})
 }
 if(names.some(n=>n.includes("esparguete")) && names.some(n=>n.includes("frango"))){
  s.push({title:"Esparguete com frango", cost:computeMealCost(["esparguete","frango"])})
 }
 if(names.some(n=>n.includes("ovo"))){
  s.push({title:"Ovos mexidos", cost:computeMealCost(["ovo"])})
 }
 setSuggestions(s)
}

return(
<div>

<h2>Poupan√ßa MealPrep</h2>

<div className="row">
<button onClick={()=>setShowForm(true)}>Adicionar Manualmente</button>
<button className="alt" onClick={startScanner}>Scan C√≥digo de Barras</button>
</div>

{/* Dashboard Financeiro */}
<div className="card">
<b>Dashboard Semanal</b>
<div>üí∞ Rendimento semanal: ‚Ç¨ {weeklyIncome().toFixed(2)}</div>
<div>üõí Gasto alimentar atual: ‚Ç¨ {weeklyFoodSpend().toFixed(2)}</div>
<div>üçΩÔ∏è Custo m√©dio por refei√ß√£o: ‚Ç¨ {avgMealCost()}</div>
<div>‚è±Ô∏è Trabalho por refei√ß√£o: {workMinutesPerMeal()} min</div>

{expensiveAlerts().length>0 && (
<div style={{marginTop:"6px",color:"#ff6b6b"}}>
‚ö†Ô∏è Produtos acima do pre√ßo habitual:
{expensiveAlerts().map(i=>(
 <div key={i.id}>{i.name} (‚Ç¨ {i.price})</div>
))}
</div>
)}
</div>

{/* Invent√°rio */}
{items.map(i=>(
<div className="card" key={i.id}>
<b>{i.name}</b>
<span className="badge">{i.store||"‚Äî"}</span>
<br/>
Qtd: {i.qty||"?"} | ‚Ç¨ {i.price||"?"}
<div className="small">C√≥digo: {i.barcode||"‚Äî"}</div>
<div className="row">
<button onClick={()=>consume(i.id)}>Consumir</button>
<button className="alt" onClick={()=>addPriceRecord(i.id)}>Atualizar Pre√ßo</button>
</div>
{i.history?.length>0 && (
<div className="small">
√öltimos pre√ßos: {i.history.slice(-3).map(h=>`${h.price}‚Ç¨ ${h.store}`).join(" | ")}
</div>
)}
</div>
))}

{/* Sugest√µes */}
<div className="card">
<b>Sugest√µes de Refei√ß√£o (autom√°tico)</b>
{suggestions.length===0 && <div className="small">Sem combina√ß√µes ainda</div>}
{suggestions.map((s,i)=>(
<div key={i}>{s.title} ‚Äî Custo estimado: ‚Ç¨ {s.cost}</div>
))}
</div>

{/* Modal Form */}
{showForm&&(
<div className="modal">
<div className="modal-content">
<h3>Novo Produto</h3>

<input placeholder="Nome"
value={newItem.name}
onChange={e=>setNewItem({...newItem,name:e.target.value})}/>

<input placeholder="Pre√ßo ‚Ç¨"
value={newItem.price}
onChange={e=>setNewItem({...newItem,price:e.target.value})}/>

<input placeholder="Quantidade (ex: 500 g / 6 un)"
value={newItem.qty}
onChange={e=>setNewItem({...newItem,qty:e.target.value})}/>

<select value={newItem.store} onChange={e=>setNewItem({...newItem,store:e.target.value})}>
{STORES.map(s=><option key={s}>{s}</option>)}
</select>

<div className="small">C√≥digo: {newItem.barcode||"‚Äî"}</div>

<div className="row">
<button onClick={addItem}>Guardar</button>
<button className="warn" onClick={()=>setShowForm(false)}>Cancelar</button>
</div>
</div>
</div>
)}

{/* Modal Scanner */}
{showScanner&&(
<div className="modal">
<div className="modal-content">
<h3>Scanner</h3>
<div id="scanner" style={{width:"100%",height:"260px",background:"#000"}}></div>
<div className="row">
<button className="warn" onClick={stopScanner}>Sair do Scanner</button>
</div>
<div className="small">Se n√£o reconhecer, sai e adiciona manualmente.</div>
</div>
</div>
)}

</div>
)
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>)

if('serviceWorker' in navigator){
 navigator.serviceWorker.register('service-worker.js')
}

</script>
</body>
</html>
