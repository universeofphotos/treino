<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Poupança MealPrep</title>

<link rel="manifest" href="manifest.json">

<script src="https://unpkg.com/quagga/dist/quagga.min.js"></script>
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<style>
body{background:#121212;color:white;font-family:Arial;margin:0;padding:10px}
.card{background:#1e1e1e;padding:10px;margin:10px 0;border-radius:10px}
button{padding:8px;margin:4px;border-radius:6px;border:none;background:#2e7d32;color:white}
input{padding:6px;margin:4px;background:#333;color:white;border:1px solid #555}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:#000c;display:flex;align-items:center;justify-content:center}
.modal-content{background:#1e1e1e;padding:15px;border-radius:10px;width:90%}
</style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">

function App(){

const [items,setItems]=React.useState(JSON.parse(localStorage.getItem("items")||"[]"))
const [showForm,setShowForm]=React.useState(false)
const [showScanner,setShowScanner]=React.useState(false)
const [newItem,setNewItem]=React.useState({name:"",price:"",qty:"",barcode:""})

React.useEffect(()=>{
 localStorage.setItem("items",JSON.stringify(items))
},[items])

function addItem(){
 if(!newItem.name) return
 setItems([...items,{...newItem,id:Date.now()}])
 setNewItem({name:"",price:"",qty:"",barcode:""})
 setShowForm(false)
}

function consume(id){
 const q=prompt("Quanto consumiste?")
 if(!q) return
 setItems(items.map(i=> i.id===id ? {...i,qty:Math.max(0,(parseFloat(i.qty)-parseFloat(q)).toString())}:i))
}

function startScanner(){
 setShowScanner(true)
 setTimeout(()=>{
 Quagga.init({
 inputStream:{type:"LiveStream",target:document.querySelector('#scanner')},
 decoder:{readers:["ean_reader","code_128_reader"]}
 },err=>{
 if(!err){
 Quagga.start()
 Quagga.onDetected(data=>{
 setNewItem({...newItem,barcode:data.codeResult.code})
 setShowScanner(false)
 Quagga.stop()
 setShowForm(true)
 })
 }
 })
 },300)
}

return(
<div>

<h2>Poupança MealPrep</h2>

<button onClick={()=>setShowForm(true)}>Adicionar Manualmente</button>
<button onClick={startScanner}>Scan Código de Barras</button>

{items.map(i=>(
<div className="card" key={i.id}>
<b>{i.name}</b><br/>
Qtd: {i.qty} | € {i.price}
<br/>
<button onClick={()=>consume(i.id)}>Consumir</button>
</div>
))}

{showForm&&(
<div className="modal">
<div className="modal-content">
<h3>Novo Produto</h3>

<input placeholder="Nome"
value={newItem.name}
onChange={e=>setNewItem({...newItem,name:e.target.value})}/>

<input placeholder="Preço €"
value={newItem.price}
onChange={e=>setNewItem({...newItem,price:e.target.value})}/>

<input placeholder="Quantidade"
value={newItem.qty}
onChange={e=>setNewItem({...newItem,qty:e.target.value})}/>

<div>Código: {newItem.barcode}</div>

<button onClick={addItem}>Guardar</button>
<button onClick={()=>setShowForm(false)}>Cancelar</button>
</div>
</div>
)}

{showScanner&&(
<div className="modal">
<div className="modal-content">
<h3>Scanner</h3>
<div id="scanner" style={{width:"100%",height:"300px"}}></div>
<button onClick={()=>{setShowScanner(false);Quagga.stop()}}>Fechar</button>
</div>
</div>
)}

</div>
)
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>)

if('serviceWorker' in navigator){
 navigator.serviceWorker.register('service-worker.js')
}

</script>
</body>
</html>
