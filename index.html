<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Poupan√ßa Holanda">
    <title>Poupan√ßa na Holanda</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            padding: 0;
            padding-bottom: 80px;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px 20px;
            border-radius: 0 0 20px 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 13px;
            color: #666;
        }
        
        .btn-primary {
            background: #27ae60;
            color: white;
            border: none;
            padding: 16px 24px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            cursor: pointer;
            margin-bottom: 12px;
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary:active {
            transform: scale(0.98);
        }
        
        .btn-scan {
            background: #9b59b6;
            box-shadow: 0 4px 12px rgba(155, 89, 182, 0.3);
        }
        
        .suggestion-box {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .suggestion-box.no-cook {
            border-left: 4px solid #27ae60;
        }
        
        .suggestion-box.warning {
            border-left: 4px solid #f39c12;
        }
        
        .suggestion-box.urgent {
            border-left: 4px solid #e74c3c;
        }
        
        .suggestion-box h2 {
            font-size: 18px;
            margin-bottom: 12px;
        }
        
        .recipe-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .recipe-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }
        
        .recipe-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .recipe-origin {
            font-size: 12px;
            color: #9b59b6;
            font-weight: 500;
        }
        
        .recipe-cost {
            text-align: right;
        }
        
        .cost-total {
            font-size: 20px;
            font-weight: bold;
            color: #27ae60;
        }
        
        .cost-dose {
            font-size: 12px;
            color: #666;
        }
        
        .recipe-info {
            display: flex;
            gap: 16px;
            font-size: 13px;
            color: #666;
        }
        
        .category {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .category h3 {
            font-size: 15px;
            color: #2c3e50;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .item-info {
            flex: 1;
        }
        
        .item-name {
            font-weight: 500;
            margin-bottom: 4px;
            font-size: 14px;
        }
        
        .item-details {
            font-size: 12px;
            color: #666;
        }
        
        .item-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .badge-urgent {
            background: #e74c3c;
            color: white;
        }
        
        .badge-warning {
            background: #f39c12;
            color: white;
        }
        
        .badge-ok {
            background: #27ae60;
            color: white;
        }
        
        .badge-safe {
            background: #95a5a6;
            color: white;
        }
        
        .btn-consume {
            background: #3498db;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .btn-delete {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .purchase-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .purchase-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .purchase-date {
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .purchase-store {
            font-size: 13px;
            color: #666;
        }
        
        .purchase-total {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
        }
        
        .purchase-items {
            font-size: 13px;
            line-height: 1.8;
        }
        
        .purchase-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px;
            cursor: pointer;
            border: none;
            background: none;
            color: #666;
        }
        
        .nav-item.active {
            color: #667eea;
        }
        
        .nav-icon {
            font-size: 24px;
        }
        
        .nav-label {
            font-size: 11px;
            font-weight: 500;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            font-size: 20px;
        }
        
        .btn-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 32px;
            height: 32px;
        }
        
        .product-preview {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .product-preview h3 {
            font-size: 18px;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .product-preview p {
            font-size: 14px;
            color: #666;
            margin-bottom: 4px;
        }
        
        .price-display {
            font-size: 28px;
            font-weight: bold;
            color: #27ae60;
            margin: 12px 0;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
            color: #2c3e50;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }
        
        .btn-row {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }
        
        .btn-secondary {
            flex: 1;
            padding: 12px;
            border: 1px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .btn-submit {
            flex: 1;
            padding: 12px;
            border: none;
            background: #667eea;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        
        #reader {
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .scanner-info {
            text-align: center;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 14px;
            color: #666;
        }
        
        .info-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 12px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const PRODUTOS_HOLANDA = {
            "8710400233251": { nome: "Peito de Frango AH", loja: "Albert Heijn", preco: 4.99, categoria: "Prote√≠na", quantidade: "300g" },
            "20917791": { nome: "Ovos Lidl 10 un", loja: "Lidl", preco: 2.99, categoria: "Prote√≠na", quantidade: "10 unidades" },
            "8710400018995": { nome: "Arroz Branco AH", loja: "Albert Heijn", preco: 1.29, categoria: "Hidratos", quantidade: "1kg" },
            "8710400583684": { nome: "Feij√£o Castanho AH", loja: "Albert Heijn", preco: 0.89, categoria: "Leguminosas", quantidade: "400g" },
            "8718452169412": { nome: "Esparguete Jumbo", loja: "Jumbo", preco: 0.75, categoria: "Hidratos", quantidade: "500g" },
            "8719743404786": { nome: "Ovos AH 6 un", loja: "Albert Heijn", preco: 2.45, categoria: "Prote√≠na", quantidade: "6 unidades" },
            "8712566483402": { nome: "Frango Gyros AH", loja: "Albert Heijn", preco: 5.49, categoria: "Prote√≠na", quantidade: "400g" },
            "8710400594758": { nome: "Gr√£o de Bico AH", loja: "Albert Heijn", preco: 0.95, categoria: "Leguminosas", quantidade: "400g" },
            "8710400019008": { nome: "Arroz Integral AH", loja: "Albert Heijn", preco: 1.49, categoria: "Hidratos", quantidade: "1kg" },
            "8718452203208": { nome: "Atum Natural Jumbo", loja: "Jumbo", preco: 1.25, categoria: "Prote√≠na", quantidade: "160g" }
        };

        const RECEITAS_BASE = [
            {
                id: 1,
                nome: "Feij√£o Moldavo Simples",
                origem: "Moldava",
                ingredientes: [
                    { nome: "Feij√£o", quantidade: 400, unidade: "g" },
                    { nome: "Cebola", quantidade: 1, unidade: "unidade" },
                    { nome: "√ìleo", quantidade: 2, unidade: "colheres" }
                ],
                doses: 3,
                tempo: 5,
                duracao_frigo: 3,
                custo_estimado: 1.50,
                instrucoes: [
                    "Abrir a lata de feij√£o e escorrer",
                    "Cortar a cebola em peda√ßos pequenos",
                    "Misturar feij√£o + cebola + √≥leo + sal",
                    "Pode comer frio ou morno"
                ],
                tags: ["minimalista", "moldava", "frio"]
            },
            {
                id: 2,
                nome: "Frango com Arroz",
                origem: "Base",
                ingredientes: [
                    { nome: "Frango", quantidade: 300, unidade: "g" },
                    { nome: "Arroz", quantidade: 200, unidade: "g" },
                    { nome: "Cebola", quantidade: 1, unidade: "unidade" },
                    { nome: "√ìleo", quantidade: 3, unidade: "colheres" }
                ],
                doses: 4,
                tempo: 30,
                duracao_frigo: 3,
                custo_estimado: 4.00,
                instrucoes: [
                    "Cortar o frango em cubos",
                    "Refogar a cebola no √≥leo",
                    "Adicionar o frango e cozinhar",
                    "Cozinhar o arroz separadamente",
                    "Misturar tudo"
                ],
                tags: ["panela_grande", "prote√≠na"]
            },
            {
                id: 3,
                nome: "Ovos Mexidos",
                origem: "Emerg√™ncia",
                ingredientes: [
                    { nome: "Ovos", quantidade: 3, unidade: "unidades" },
                    { nome: "√ìleo", quantidade: 1, unidade: "colher" }
                ],
                doses: 1,
                tempo: 5,
                duracao_frigo: 0,
                custo_estimado: 0.75,
                instrucoes: [
                    "Bater os ovos",
                    "Aquecer √≥leo na frigideira",
                    "Adicionar os ovos e mexer",
                    "Servir imediatamente"
                ],
                tags: ["r√°pido", "emerg√™ncia", "prote√≠na"]
            },
            {
                id: 4,
                nome: "Arroz com Ovos",
                origem: "Base",
                ingredientes: [
                    { nome: "Arroz", quantidade: 200, unidade: "g" },
                    { nome: "Ovos", quantidade: 3, unidade: "unidades" },
                    { nome: "Cebola", quantidade: 1, unidade: "unidade" },
                    { nome: "√ìleo", quantidade: 2, unidade: "colheres" }
                ],
                doses: 3,
                tempo: 20,
                duracao_frigo: 2,
                custo_estimado: 2.00,
                instrucoes: [
                    "Cozinhar o arroz",
                    "Refogar a cebola",
                    "Adicionar os ovos batidos",
                    "Misturar com o arroz"
                ],
                tags: ["simples", "prote√≠na", "barato"]
            },
            {
                id: 5,
                nome: "Gr√£o com Atum",
                origem: "Portuguesa",
                ingredientes: [
                    { nome: "Gr√£o", quantidade: 400, unidade: "g" },
                    { nome: "Atum", quantidade: 120, unidade: "g" },
                    { nome: "Cebola", quantidade: 1, unidade: "unidade" },
                    { nome: "Azeite", quantidade: 3, unidade: "colheres" }
                ],
                doses: 3,
                tempo: 5,
                duracao_frigo: 2,
                custo_estimado: 2.50,
                instrucoes: [
                    "Escorrer o gr√£o e o atum",
                    "Cortar a cebola em rodelas finas",
                    "Misturar tudo com azeite"
                ],
                tags: ["minimalista", "frio", "portuguesa"]
            }
        ];

        function calcularPrioridade(item) {
            const agora = new Date();
            const diasDesdeEntrada = Math.floor((agora - new Date(item.data_entrada)) / (1000 * 60 * 60 * 24));
            
            if (item.estado === "cozinhado") {
                if (diasDesdeEntrada >= 3) return { nivel: 1, texto: "Consumir J√Å", badge: "urgent" };
                if (diasDesdeEntrada === 2) return { nivel: 2, texto: "Hoje/amanh√£", badge: "warning" };
                return { nivel: 3, texto: "OK", badge: "ok" };
            }
            
            if (item.estado === "aberto") {
                if (diasDesdeEntrada >= 3) return { nivel: 2, texto: "Consumir breve", badge: "warning" };
                return { nivel: 3, texto: "OK", badge: "ok" };
            }
            
            if (item.estado === "cru") {
                if (diasDesdeEntrada >= 4) return { nivel: 2, texto: "Cozinhar j√°", badge: "warning" };
                return { nivel: 4, texto: "OK", badge: "ok" };
            }
            
            return { nivel: 5, texto: "Seguro", badge: "safe" };
        }

        function normalizarNome(nome) {
            return nome.toLowerCase()
                .replace(/\s+ah$/i, '')
                .replace(/\s+jumbo$/i, '')
                .replace(/\s+lidl$/i, '')
                .replace(/\s+de\s+/gi, ' ')
                .replace(/integral/gi, '')
                .replace(/branco/gi, '')
                .replace(/castanho/gi, '')
                .replace(/\s+/g, ' ')
                .trim();
        }

        function temIngrediente(ingredienteReceita, inventario) {
            const ingNormalizado = normalizarNome(ingredienteReceita);
            const palavraChave = ingNormalizado.split(' ')[0];
            
            return inventario.some(produto => {
                const prodNormalizado = normalizarNome(produto);
                return prodNormalizado.includes(palavraChave) || palavraChave.includes(prodNormalizado);
            });
        }

        function encontrarMelhorReceita(items, receitas) {
            if (items.length === 0) {
                return receitas[0];
            }
            
            const inventario = items.map(i => i.nome);
            
            const receitasComScore = receitas.map(receita => {
                let matches = 0;
                receita.ingredientes.forEach(ing => {
                    if (temIngrediente(ing.nome, inventario)) {
                        matches++;
                    }
                });
                
                return {
                    receita,
                    score: matches / receita.ingredientes.length,
                    matches
                };
            });
            
            receitasComScore.sort((a, b) => {
                if (Math.abs(b.score - a.score) > 0.01) {
                    return b.score - a.score;
                }
                return a.receita.custo_estimado - b.receita.custo_estimado;
            });
            
            console.log("=== RECEITAS ===");
            receitasComScore.forEach(r => {
                console.log(`${r.receita.nome}: ${r.matches}/${r.receita.ingredientes.length}`);
            });
            
            if (receitasComScore[0].score < 0.25) {
                return receitas.reduce((a, b) => a.custo_estimado < b.custo_estimado ? a : b);
            }
            
            return receitasComScore[0].receita;
        }

        function gerarSugestao(items, receitas) {
            const comidaPronta = items.filter(i => i.estado === "cozinhado" && calcularPrioridade(i).nivel >= 3);
            const itensUrgentes = items.filter(i => calcularPrioridade(i).nivel <= 2);
            
            if (comidaPronta.length > 0) {
                return {
                    tipo: "no-cook",
                    titulo: "‚úÖ N√£o cozinhar hoje",
                    mensagem: `Tens ${comidaPronta.length} refei√ß√£o/√µes pronta(s).`,
                    items: comidaPronta,
                    receita: null
                };
            }
            
            if (itensUrgentes.length > 0) {
                return {
                    tipo: "urgent",
                    titulo: "üî¥ Cozinhar hoje",
                    mensagem: `${itensUrgentes.length} item(ns) a estragar.`,
                    items: itensUrgentes,
                    receita: encontrarMelhorReceita(items, receitas)
                };
            }
            
            const temProteina = items.some(i => i.categoria === "Prote√≠na" && i.estado === "cru");
            if (temProteina) {
                return {
                    tipo: "warning",
                    titulo: "‚ö†Ô∏è Sem comida pronta",
                    mensagem: "Tens ingredientes frescos dispon√≠veis.",
                    receita: encontrarMelhorReceita(items, receitas)
                };
            }
            
            return {
                tipo: "ok",
                titulo: "üòå Invent√°rio baixo",
                mensagem: "Considera fazer compras.",
                receita: null
            };
        }

        function calcularGastos(items) {
            const agora = new Date();
            const semanaAtras = new Date(agora.getTime() - 7 * 24 * 60 * 60 * 1000);
            const mesAtras = new Date(agora.getTime() - 30 * 24 * 60 * 60 * 1000);
            
            const itemsSemana = items.filter(i => new Date(i.data_entrada) >= semanaAtras);
            const itemsMes = items.filter(i => new Date(i.data_entrada) >= mesAtras);
            
            return {
                semana: { 
                    total: itemsSemana.reduce((s, i) => s + (parseFloat(i.preco) || 0), 0), 
                    items: itemsSemana.length 
                },
                mes: { 
                    total: itemsMes.reduce((s, i) => s + (parseFloat(i.preco) || 0), 0), 
                    items: itemsMes.length 
                }
            };
        }

        function agruparCompras(items) {
            const comprasPorData = {};
            
            items.forEach(item => {
                const data = new Date(item.data_entrada).toLocaleDateString('pt-PT');
                if (!comprasPorData[data]) {
                    comprasPorData[data] = {
                        data: item.data_entrada,
                        loja: item.loja,
                        items: [],
                        total: 0
                    };
                }
                comprasPorData[data].items.push(item);
                comprasPorData[data].total += parseFloat(item.preco) || 0;
            });
            
            return Object.values(comprasPorData).sort((a, b) => new Date(b.data) - new Date(a.data));
        }

        function App() {
            const [activeTab, setActiveTab] = useState('home');
            const [items, setItems] = useState(() => {
                const saved = localStorage.getItem('poupanca-holanda-items');
                return saved ? JSON.parse(saved).map(item => ({
                    ...item,
                    data_entrada: new Date(item.data_entrada)
                })) : [];
            });
            
            const [productDatabase, setProductDatabase] = useState(() => {
                const saved = localStorage.getItem('poupanca-holanda-products');
                return saved ? JSON.parse(saved) : PRODUTOS_HOLANDA;
            });
            
            const [showSuggestion, setShowSuggestion] = useState(false);
            const [showScanModal, setShowScanModal] = useState(false);
            const [showConfirmModal, setShowConfirmModal] = useState(false);
            const [showManualModal, setShowManualModal] = useState(false);
            const [showConsumeModal, setShowConsumeModal] = useState(false);
            const [showRecipeModal, setShowRecipeModal] = useState(false);
            const [selectedRecipe, setSelectedRecipe] = useState(null);
            const [selectedItem, setSelectedItem] = useState(null);
            const [scannedProduct, setScannedProduct] = useState(null);
            const [scanning, setScanning] = useState(false);
            const scannerRef = useRef(null);
            
            const [consumeAmount, setConsumeAmount] = useState("");
            
            const [manualProduct, setManualProduct] = useState({
                codigo_barras: "",
                nome: "",
                categoria: "Prote√≠na",
                quantidade: "",
                estado: "cru",
                preco: "",
                loja: ""
            });
            
            useEffect(() => {
                localStorage.setItem('poupanca-holanda-items', JSON.stringify(items));
            }, [items]);
            
            useEffect(() => {
                localStorage.setItem('poupanca-holanda-products', JSON.stringify(productDatabase));
            }, [productDatabase]);
            
            const categorias = {
                "Prote√≠na": "ü•©",
                "Hidratos": "üçö",
                "Leguminosas": "ü´ò",
                "Vegetais": "ü•¨",
                "Extras": "üßÇ"
            };
            
            const gastos = calcularGastos(items);
            const compras = agruparCompras(items);
            const custoTotal = items.reduce((sum, item) => sum + (parseFloat(item.preco) || 0), 0);
            const sugestao = gerarSugestao(items, RECEITAS_BASE);
            
            const handleConsumeItem = (item) => {
                setSelectedItem(item);
                setConsumeAmount("");
                setShowConsumeModal(true);
            };
            
            const handleConfirmConsume = () => {
                if (!consumeAmount) {
                    alert("Indica quanto sobra");
                    return;
                }
                
                const unidade = selectedItem.quantidade.split(' ').slice(1).join(' ');
                const novaQuantidade = `${consumeAmount} ${unidade}`;
                
                setItems(items.map(i => 
                    i.id === selectedItem.id ? { ...i, quantidade: novaQuantidade } : i
                ));
                
                setShowConsumeModal(false);
                setSelectedItem(null);
                setConsumeAmount("");
            };
            
            const handleScanSuccess = (barcode) => {
                if (scannerRef.current) {
                    scannerRef.current.stop();
                }
                setScanning(false);
                setShowScanModal(false);
                
                const produtoPessoal = items.find(i => i.codigo_barras === barcode);
                if (produtoPessoal) {
                    setScannedProduct({ ...produtoPessoal, fonte: "pessoal" });
                    setShowConfirmModal(true);
                    return;
                }
                
                const produtoHolanda = productDatabase[barcode];
                if (produtoHolanda) {
                    setScannedProduct({
                        codigo_barras: barcode,
                        ...produtoHolanda,
                        estado: "cru",
                        fonte: "holanda"
                    });
                    setShowConfirmModal(true);
                    return;
                }
                
                setManualProduct({
                    codigo_barras: barcode,
                    nome: "",
                    categoria: "Prote√≠na",
                    quantidade: "",
                    estado: "cru",
                    preco: "",
                    loja: ""
                });
                setShowManualModal(true);
            };
            
            const handleConfirmProduct = (customPrice = null) => {
                const novoItem = {
                    id: Date.now(),
                    codigo_barras: scannedProduct.codigo_barras,
                    nome: scannedProduct.nome,
                    categoria: scannedProduct.categoria,
                    quantidade: scannedProduct.quantidade,
                    estado: scannedProduct.estado,
                    preco: customPrice !== null ? customPrice : scannedProduct.preco,
                    loja: scannedProduct.loja,
                    data_entrada: new Date()
                };
                
                setItems([...items, novoItem]);
                
                if (scannedProduct.fonte === "holanda" || customPrice !== null) {
                    setProductDatabase({
                        ...productDatabase,
                        [scannedProduct.codigo_barras]: {
                            nome: scannedProduct.nome,
                            loja: scannedProduct.loja,
                            preco: customPrice !== null ? customPrice : scannedProduct.preco,
                            categoria: scannedProduct.categoria,
                            quantidade: scannedProduct.quantidade
                        }
                    });
                }
                
                setShowConfirmModal(false);
                setScannedProduct(null);
            };
            
            const handleManualAdd = () => {
                if (!manualProduct.nome || !manualProduct.preco) {
                    alert("Preenche nome e pre√ßo");
                    return;
                }
                
                const novoItem = {
                    id: Date.now(),
                    ...manualProduct,
                    preco: parseFloat(manualProduct.preco),
                    data_entrada: new Date()
                };
                
                setItems([...items, novoItem]);
                
                if (manualProduct.codigo_barras) {
                    setProductDatabase({
                        ...productDatabase,
                        [manualProduct.codigo_barras]: {
                            nome: manualProduct.nome,
                            loja: manualProduct.loja,
                            preco: parseFloat(manualProduct.preco),
                            categoria: manualProduct.categoria,
                            quantidade: manualProduct.quantidade
                        }
                    });
                }
                
                setManualProduct({
                    codigo_barras: "",
                    nome: "",
                    categoria: "Prote√≠na",
                    quantidade: "",
                    estado: "cru",
                    preco: "",
                    loja: ""
                });
                setShowManualModal(false);
            };
            
            const handleDeleteItem = (id) => {
                if (confirm("Remover?")) {
                    setItems(items.filter(i => i.id !== id));
                }
            };
            
            const startScanner = () => {
                setScanning(true);
                setTimeout(() => {
                    const html5QrCode = new Html5Qrcode("reader");
                    html5QrCode.start(
                        { facingMode: "environment" },
                        { fps: 10, qrbox: 250 },
                        handleScanSuccess,
                        () => {}
                    ).catch(() => {
                        alert("Erro c√¢mara");
                        setScanning(false);
                    });
                    scannerRef.current = html5QrCode;
                }, 100);
            };
            
            const stopScanner = () => {
                if (scannerRef.current) {
                    scannerRef.current.stop();
                    setScanning(false);
                }
                setShowScanModal(false);
            };
            
            useEffect(() => {
                return () => {
                    if (scannerRef.current) {
                        scannerRef.current.stop();
                    }
                };
            }, []);
            
            return (
                <>
                    <div className="header">
                        <h1><span>üá≥üá±</span><span>Poupan√ßa Holanda</span></h1>
                        <p>M√°xima poupan√ßa, zero desperd√≠cio</p>
                    </div>
                    
                    <div className="container">
                        {activeTab === 'home' && (
                            <>
                                <div className="stats">
                                    <div className="stat-card">
                                        <div className="stat-value">‚Ç¨{custoTotal.toFixed(2)}</div>
                                        <div className="stat-label">Em stock</div>
                                    </div>
                                    <div className="stat-card">
                                        <div className="stat-value">{items.length}</div>
                                        <div className="stat-label">Produtos</div>
                                    </div>
                                </div>
                                
                                <button className="btn-primary" onClick={() => setShowSuggestion(!showSuggestion)}>
                                    <span>ü§î</span>
                                    <span>{showSuggestion ? "Esconder" : "O que cozinho?"}</span>
                                </button>
                                
                                {showSuggestion && (
                                    <div className={`suggestion-box ${sugestao.tipo}`}>
                                        <h2>{sugestao.titulo}</h2>
                                        <p style={{fontSize: '14px', marginBottom: '12px'}}>{sugestao.mensagem}</p>
                                        
                                        {sugestao.items && sugestao.items.length > 0 && (
                                            <ul style={{marginLeft: '20px', marginBottom: '12px', fontSize: '14px'}}>
                                                {sugestao.items.map(item => (
                                                    <li key={item.id}>{item.nome} ({item.quantidade})</li>
                                                ))}
                                            </ul>
                                        )}
                                        
                                        {sugestao.receita && (
                                            <div className="recipe-card" style={{cursor: 'pointer'}}
                                                 onClick={() => {
                                                     setSelectedRecipe(sugestao.receita);
                                                     setShowRecipeModal(true);
                                                 }}>
                                                <div className="recipe-header">
                                                    <div>
                                                        <div className="recipe-title">{sugestao.receita.nome}</div>
                                                        <div className="recipe-origin">{sugestao.receita.origem}</div>
                                                    </div>
                                                    <div className="recipe-cost">
                                                        <div className="cost-total">‚Ç¨{sugestao.receita.custo_estimado.toFixed(2)}</div>
                                                        <div className="cost-dose">‚Ç¨{(sugestao.receita.custo_estimado / sugestao.receita.doses).toFixed(2)}/dose</div>
                                                    </div>
                                                </div>
                                                <div className="recipe-info">
                                                    <span>‚è±Ô∏è {sugestao.receita.tempo} min</span>
                                                    <span>üçΩÔ∏è {sugestao.receita.doses} doses</span>
                                                    <span>‚ùÑÔ∏è {sugestao.receita.duracao_frigo} dias</span>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}
                                
                                <button className="btn-primary btn-scan" onClick={() => setShowScanModal(true)}>
                                    <span>üì∑</span>
                                    <span>Scan c√≥digo</span>
                                </button>
                                
                                {items.length === 0 && (
                                    <div style={{textAlign: 'center', padding: '40px 20px', color: '#666'}}>
                                        <div style={{fontSize: '48px', marginBottom: '16px'}}>üõí</div>
                                        <p>Sem produtos</p>
                                    </div>
                                )}
                                
                                {Object.entries(categorias).map(([categoria, icon]) => {
                                    const itensCategoria = items.filter(i => i.categoria === categoria);
                                    if (itensCategoria.length === 0) return null;
                                    
                                    return (
                                        <div key={categoria} className="category">
                                            <h3><span>{icon}</span><span>{categoria}</span></h3>
                                            {itensCategoria.map(item => {
                                                const prioridade = calcularPrioridade(item);
                                                return (
                                                    <div key={item.id} className="item">
                                                        <div className="item-info">
                                                            <div className="item-name">{item.nome}</div>
                                                            <div className="item-details">
                                                                {item.quantidade} ‚Ä¢ {item.estado} ‚Ä¢ ‚Ç¨{item.preco} ‚Ä¢ {item.loja}
                                                            </div>
                                                        </div>
                                                        <div className="item-actions">
                                                            <span className={`badge badge-${prioridade.badge}`}>
                                                                {prioridade.texto}
                                                            </span>
                                                            <button className="btn-consume" onClick={() => handleConsumeItem(item)}>
                                                                üìâ
                                                            </button>
                                                            <button className="btn-delete" onClick={() => handleDeleteItem(item.id)}>
                                                                ‚úï
                                                            </button>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    );
                                })}
                            </>
                        )}
                        
                        {activeTab === 'receitas' && (
                            <>
                                <h2 style={{fontSize: '20px', marginBottom: '16px'}}>Receitas</h2>
                                {RECEITAS_BASE.map(receita => (
                                    <div key={receita.id} className="recipe-card" style={{cursor: 'pointer'}}
                                         onClick={() => {
                                             setSelectedRecipe(receita);
                                             setShowRecipeModal(true);
                                         }}>
                                        <div className="recipe-header">
                                            <div>
                                                <div className="recipe-title">{receita.nome}</div>
                                                <div className="recipe-origin">{receita.origem}</div>
                                            </div>
                                            <div className="recipe-cost">
                                                <div className="cost-total">‚Ç¨{receita.custo_estimado.toFixed(2)}</div>
                                                <div className="cost-dose">‚Ç¨{(receita.custo_estimado / receita.doses).toFixed(2)}/dose</div>
                                            </div>
                                        </div>
                                        <div className="recipe-info">
                                            <span>‚è±Ô∏è {receita.tempo} min</span>
                                            <span>üçΩÔ∏è {receita.doses} doses</span>
                                            <span>‚ùÑÔ∏è {receita.duracao_frigo} dias</span>
                                        </div>
                                    </div>
                                ))}
                            </>
                        )}
                        
                        {activeTab === 'gastos' && (
                            <>
                                <h2 style={{fontSize: '20px', marginBottom: '16px'}}>üí∞ Gastos</h2>
                                <div className="stats">
                                    <div className="stat-card">
                                        <div className="stat-label">Esta Semana</div>
                                        <div className="stat-value">‚Ç¨{gastos.semana.total.toFixed(2)}</div>
                                        <div className="stat-label">{gastos.semana.items} produtos</div>
                                    </div>
                                    <div className="stat-card">
                                        <div className="stat-label">Este M√™s</div>
                                        <div className="stat-value">‚Ç¨{gastos.mes.total.toFixed(2)}</div>
                                        <div className="stat-label">{gastos.mes.items} produtos</div>
                                    </div>
                                </div>
                                
                                <h3 style={{fontSize: '16px', marginTop: '24px', marginBottom: '12px'}}>üì¶ Compras</h3>
                                {compras.length === 0 ? (
                                    <div style={{textAlign: 'center', padding: '40px', color: '#666'}}>
                                        <p>Sem compras</p>
                                    </div>
                                ) : (
                                    compras.map((compra, idx) => (
                                        <div key={idx} className="purchase-card">
                                            <div className="purchase-header">
                                                <div>
                                                    <div className="purchase-date">
                                                        üõí {new Date(compra.data).toLocaleDateString('pt-PT', { day: 'numeric', month: 'short' })}
                                                    </div>
                                                    <div className="purchase-store">{compra.loja}</div>
                                                </div>
                                                <div className="purchase-total">‚Ç¨{compra.total.toFixed(2)}</div>
                                            </div>
                                            <div className="purchase-items">
                                                {compra.items.map(item => (
                                                    <div key={item.id} className="purchase-item">
                                                        <span>‚Ä¢ {item.nome}</span>
                                                        <span>‚Ç¨{item.preco}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ))
                                )}
                            </>
                        )}
                    </div>
                    
                    <div className="bottom-nav">
                        <button className={`nav-item ${activeTab === 'home' ? 'active' : ''}`} onClick={() => setActiveTab('home')}>
                            <div className="nav-icon">üè†</div>
                            <div className="nav-label">In√≠cio</div>
                        </button>
                        <button className={`nav-item ${activeTab === 'receitas' ? 'active' : ''}`} onClick={() => setActiveTab('receitas')}>
                            <div className="nav-icon">üìñ</div>
                            <div className="nav-label">Receitas</div>
                        </button>
                        <button className={`nav-item ${activeTab === 'gastos' ? 'active' : ''}`} onClick={() => setActiveTab('gastos')}>
                            <div className="nav-icon">üí∞</div>
                            <div className="nav-label">Gastos</div>
                        </button>
                    </div>
                    
                    {showScanModal && (
                        <div className="modal" onClick={stopScanner}>
                            <div className="modal-content" onClick={e => e.stopPropagation()}>
                                <div className="modal-header">
                                    <h2>Scan</h2>
                                    <button className="btn-close" onClick={stopScanner}>√ó</button>
                                </div>
                                <div id="reader"></div>
                                {!scanning && (
                                    <button className="btn-submit" style={{width: '100%', marginTop: '16px'}} onClick={startScanner}>
                                        Iniciar
                                    </button>
                                )}
                                <div className="scanner-info">Aponta para o c√≥digo</div>
                            </div>
                        </div>
                    )}
                    
                    {showConfirmModal && scannedProduct && (
                        <div className="modal" onClick={() => setShowConfirmModal(false)}>
                            <div className="modal-content" onClick={e => e.stopPropagation()}>
                                <div className="modal-header">
                                    <h2>Produto</h2>
                                    <button className="btn-close" onClick={() => setShowConfirmModal(false)}>√ó</button>
                                </div>
                                {scannedProduct.fonte === "pessoal" && <div className="info-badge">‚úÖ J√° compraste</div>}
                                {scannedProduct.fonte === "holanda" && <div className="info-badge">üá≥üá± Base NL</div>}
                                <div className="product-preview">
                                    <h3>{scannedProduct.nome}</h3>
                                    <p>üè™ {scannedProduct.loja}</p>
                                    <p>üì¶ {scannedProduct.quantidade}</p>
                                    <div className="price-display">‚Ç¨{scannedProduct.preco}</div>
                                </div>
                                <p style={{fontSize: '14px', color: '#666', textAlign: 'center', marginBottom: '16px'}}>
                                    Pre√ßo OK?
                                </p>
                                <div className="btn-row">
                                    <button className="btn-secondary" onClick={() => {
                                        const p = prompt("Pre√ßo?", scannedProduct.preco);
                                        if (p) handleConfirmProduct(parseFloat(p));
                                    }}>
                                        Mudar
                                    </button>
                                    <button className="btn-submit" onClick={() => handleConfirmProduct()}>
                                        ‚úÖ Confirmar
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {showManualModal && (
                        <div className="modal" onClick={() => setShowManualModal(false)}>
                            <div className="modal-content" onClick={e => e.stopPropagation()}>
                                <div className="modal-header">
                                    <h2>Novo</h2>
                                    <button className="btn-close" onClick={() => setShowManualModal(false)}>√ó</button>
                                </div>
                                <div className="info-badge">‚ÑπÔ∏è N√£o encontrado</div>
                                <div className="form-group">
                                    <label>Nome *</label>
                                    <input type="text" value={manualProduct.nome} 
                                           onChange={e => setManualProduct({...manualProduct, nome: e.target.value})}
                                           placeholder="Ex: Frango"/>
                                </div>
                                <div className="form-group">
                                    <label>Categoria</label>
                                    <select value={manualProduct.categoria} 
                                            onChange={e => setManualProduct({...manualProduct, categoria: e.target.value})}>
                                        {Object.keys(categorias).map(cat => <option key={cat} value={cat}>{cat}</option>)}
                                    </select>
                                </div>
                                <div className="form-group">
                                    <label>Quantidade</label>
                                    <input type="text" value={manualProduct.quantidade}
                                           onChange={e => setManualProduct({...manualProduct, quantidade: e.target.value})}
                                           placeholder="Ex: 500g"/>
                                </div>
                                <div className="form-group">
                                    <label>Pre√ßo (‚Ç¨) *</label>
                                    <input type="number" step="0.01" value={manualProduct.preco}
                                           onChange={e => setManualProduct({...manualProduct, preco: e.target.value})}
                                           placeholder="Ex: 3.99"/>
                                </div>
                                <div className="form-group">
                                    <label>Loja</label>
                                    <input type="text" value={manualProduct.loja}
                                           onChange={e => setManualProduct({...manualProduct, loja: e.target.value})}
                                           placeholder="Ex: Albert Heijn"/>
                                </div>
                                <div className="btn-row">
                                    <button className="btn-secondary" onClick={() => setShowManualModal(false)}>Cancelar</button>
                                    <button className="btn-submit" onClick={handleManualAdd}>Adicionar</button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {showConsumeModal && selectedItem && (
                        <div className="modal" onClick={() => setShowConsumeModal(false)}>
                            <div className="modal-content" onClick={e => e.stopPropagation()}>
                                <div className="modal-header">
                                    <h2>Consumir</h2>
                                    <button className="btn-close" onClick={() => setShowConsumeModal(false)}>√ó</button>
                                </div>
                                <div className="product-preview">
                                    <h3>{selectedItem.nome}</h3>
                                    <p>Atual: <strong>{selectedItem.quantidade}</strong></p>
                                </div>
                                <div className="form-group">
                                    <label>Quanto sobra?</label>
                                    <input type="text" value={consumeAmount}
                                           onChange={e => setConsumeAmount(e.target.value)}
                                           placeholder="Ex: 250"/>
                                    <p style={{fontSize: '12px', color: '#666', marginTop: '8px'}}>S√≥ o n√∫mero</p>
                                </div>
                                <div className="btn-row">
                                    <button className="btn-secondary" onClick={() => setShowConsumeModal(false)}>Cancelar</button>
                                    <button className="btn-submit" onClick={handleConfirmConsume}>Atualizar</button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {showRecipeModal && selectedRecipe && (
                        <div className="modal" onClick={() => setShowRecipeModal(false)}>
                            <div className="modal-content" onClick={e => e.stopPropagation()}>
                                <div className="modal-header">
                                    <h2>{selectedRecipe.nome}</h2>
                                    <button className="btn-close" onClick={() => setShowRecipeModal(false)}>√ó</button>
                                </div>
                                <div style={{marginBottom: '16px'}}>
                                    <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '12px'}}>
                                        <div>
                                            <div style={{fontSize: '13px', color: '#666'}}>Origem</div>
                                            <div style={{fontWeight: '500', color: '#9b59b6'}}>{selectedRecipe.origem}</div>
                                        </div>
                                        <div style={{textAlign: 'right'}}>
                                            <div style={{fontSize: '13px', color: '#666'}}>Custo</div>
                                            <div style={{fontSize: '20px', fontWeight: 'bold', color: '#27ae60'}}>
                                                ‚Ç¨{selectedRecipe.custo_estimado.toFixed(2)}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="recipe-info">
                                        <span>‚è±Ô∏è {selectedRecipe.tempo} min</span>
                                        <span>üçΩÔ∏è {selectedRecipe.doses} doses</span>
                                        <span>‚ùÑÔ∏è {selectedRecipe.duracao_frigo} dias</span>
                                    </div>
                                </div>
                                <div className="form-group">
                                    <label>Ingredientes</label>
                                    <ul style={{marginLeft: '20px', fontSize: '14px', lineHeight: '1.8'}}>
                                        {selectedRecipe.ingredientes.map((ing, idx) => (
                                            <li key={idx}>{ing.nome} ‚Äî {ing.quantidade} {ing.unidade}</li>
                                        ))}
                                    </ul>
                                </div>
                                <div className="form-group">
                                    <label>Instru√ß√µes</label>
                                    <ol style={{marginLeft: '20px', fontSize: '14px', lineHeight: '1.8'}}>
                                        {selectedRecipe.instrucoes.map((inst, idx) => <li key={idx}>{inst}</li>)}
                                    </ol>
                                </div>
                                <button className="btn-submit" style={{width: '100%', marginTop: '12px'}}
                                        onClick={() => setShowRecipeModal(false)}>
                                    Fechar
                                </button>
                            </div>
                        </div>
                    )}
                </>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
